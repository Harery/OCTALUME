# OCTALUME v2.2 Retrofit Implementation Plan
## Integrating Auto-Claude's Hidden Secrets

**Version**: 2.2  
**Based On**: Auto-Claude v2.7.4 Deep Analysis  
**Status**: Ready for Implementation

---

## ğŸ¯ Scope Overview

From the [Auto-Claude Hidden Secrets Analysis](AUTO_CLAUDE_HIDDEN_SECRETS.md), we identified **6 HIGH priority features** for v2.2:

1. **Thinking Levels System** - Phase-aware extended thinking
2. **Agent Configuration Registry** - Centralized agent configs
3. **Context Compaction** - Token reduction between phases
4. **Insight Extraction** - Post-session learning
5. **Recovery System** - Failure classification & rollback
6. **Post-Session Processing** - Automated memory updates

---

## ğŸ“ New Files to Create

```
.claude/
â”œâ”€â”€ thinking/
â”‚   â”œâ”€â”€ thinking-levels.json        # Token budget configuration
â”‚   â””â”€â”€ thinking-manager.js         # Phase-aware thinking control
â”œâ”€â”€ agents/
â”‚   â””â”€â”€ agent-configs.json          # Centralized agent registry
â”œâ”€â”€ compaction/
â”‚   â”œâ”€â”€ compaction-config.json      # Phase output mapping
â”‚   â””â”€â”€ context-compactor.js        # Summarization engine
â”œâ”€â”€ insights/
â”‚   â”œâ”€â”€ insight-schema.json         # Structured insight format
â”‚   â””â”€â”€ insight-extractor.js        # Post-session extraction
â”œâ”€â”€ recovery/
â”‚   â”œâ”€â”€ recovery-config.json        # Failure patterns
â”‚   â”œâ”€â”€ recovery-manager.js         # Recovery orchestration
â”‚   â””â”€â”€ attempt-history.json        # Tracking file
â””â”€â”€ commands/
    â”œâ”€â”€ thinking-config.md          # /thinking-config command
    â”œâ”€â”€ compact-context.md          # /compact-context command
    â”œâ”€â”€ extract-insights.md         # /extract-insights command
    â””â”€â”€ recovery-check.md           # /recovery-check command

scripts/
â”œâ”€â”€ thinking-manager.sh             # CLI for thinking levels
â”œâ”€â”€ context-compactor.sh            # CLI for compaction
â”œâ”€â”€ insight-extractor.sh            # CLI for insights
â””â”€â”€ recovery-manager.sh             # CLI for recovery
```

---

## 1. ğŸ§  Thinking Levels System

### thinking-levels.json
```json
{
  "version": "2.2",
  "description": "Phase-aware thinking level configuration",
  "budget_map": {
    "none": null,
    "low": 1024,
    "medium": 4096,
    "high": 16384,
    "ultrathink": 65536
  },
  "phase_defaults": {
    "P1_DISCOVERY": "ultrathink",
    "P2_RESEARCH": "medium",
    "P3_PLANNING": "high",
    "P4_IMPLEMENTATION": "none",
    "P5_VALIDATION": "high",
    "P6_REVIEW": "high",
    "P7_CRITIQUE": "ultrathink",
    "P8_DEPLOYMENT": "medium"
  },
  "agent_defaults": {
    "architect": "ultrathink",
    "planner": "high",
    "developer": "none",
    "reviewer": "high",
    "tester": "medium",
    "documenter": "low"
  }
}
```

### thinking-manager.js
```javascript
// Key functions:
// - getThinkingBudget(level) -> number | null
// - getPhaseThinking(phaseName) -> string
// - getAgentThinking(agentRole) -> string
// - formatThinkingHeader(level, budget) -> string
```

---

## 2. ğŸ“Š Agent Configuration Registry

### agent-configs.json
```json
{
  "version": "2.2",
  "agents": {
    "discovery": {
      "tools": ["Read", "Glob", "Grep", "WebFetch", "WebSearch"],
      "mcp_servers": ["context7"],
      "thinking_default": "ultrathink",
      "phases": ["P1_DISCOVERY"]
    },
    "researcher": {
      "tools": ["Read", "WebFetch", "WebSearch"],
      "mcp_servers": ["context7"],
      "thinking_default": "medium",
      "phases": ["P2_RESEARCH"]
    },
    "planner": {
      "tools": ["Read", "Write", "Edit", "WebFetch"],
      "mcp_servers": ["context7"],
      "thinking_default": "high",
      "phases": ["P3_PLANNING"]
    },
    "coder": {
      "tools": ["Read", "Write", "Edit", "Bash"],
      "mcp_servers": ["context7"],
      "thinking_default": "none",
      "phases": ["P4_IMPLEMENTATION"]
    },
    "reviewer": {
      "tools": ["Read", "Grep"],
      "mcp_servers": ["context7"],
      "thinking_default": "high",
      "phases": ["P5_VALIDATION", "P6_REVIEW"]
    },
    "critic": {
      "tools": ["Read"],
      "mcp_servers": [],
      "thinking_default": "ultrathink",
      "phases": ["P7_CRITIQUE"]
    }
  },
  "tool_sets": {
    "read_only": ["Read", "Glob", "Grep"],
    "write": ["Write", "Edit"],
    "web": ["WebFetch", "WebSearch"],
    "execute": ["Bash"]
  }
}
```

---

## 3. ğŸ“¦ Context Compaction

### compaction-config.json
```json
{
  "version": "2.2",
  "max_input_chars": 15000,
  "target_words": 500,
  "phase_outputs": {
    "P1_DISCOVERY": ["context.json", "project-index.json"],
    "P2_RESEARCH": ["research.json", "dependencies.json"],
    "P3_PLANNING": ["implementation-plan.json", "spec.md"],
    "P4_IMPLEMENTATION": [],
    "P5_VALIDATION": ["qa-report.json"],
    "P6_REVIEW": ["review-notes.md"],
    "P7_CRITIQUE": ["critique-report.json"],
    "P8_DEPLOYMENT": []
  },
  "summary_template": "## Context from Previous Phases\n\n{summaries}"
}
```

### context-compactor.js
```javascript
// Key functions:
// - gatherPhaseOutputs(specDir, phaseName) -> string
// - summarizePhaseOutput(phaseName, output, targetWords) -> string
// - formatPhaseSummaries(summaries) -> string
// - injectContext(prompt, summaries) -> string
```

---

## 4. ğŸ’¡ Insight Extraction

### insight-schema.json
```json
{
  "version": "2.2",
  "schema": {
    "file_insights": {
      "type": "array",
      "items": {
        "file": "string",
        "purpose": "string",
        "patterns": ["string"],
        "dependencies": ["string"]
      }
    },
    "patterns_discovered": {
      "type": "array",
      "items": {
        "pattern": "string",
        "applies_to": "string",
        "example": "string"
      }
    },
    "gotchas_discovered": {
      "type": "array",
      "items": {
        "gotcha": "string",
        "solution": "string",
        "severity": "low|medium|high"
      }
    },
    "approach_outcome": {
      "success": "boolean",
      "approach_used": "string",
      "why_it_worked": "string",
      "why_it_failed": "string",
      "alternatives_tried": ["string"]
    },
    "recommendations": ["string"]
  }
}
```

### insight-extractor.js
```javascript
// Key functions:
// - gatherExtractionInputs(specDir, projectDir, subtaskId, session) -> object
// - buildExtractionPrompt(inputs) -> string
// - extractInsights(inputs) -> Promise<object>
// - saveInsights(specDir, session, insights) -> void
```

---

## 5. ğŸ”„ Recovery System

### recovery-config.json
```json
{
  "version": "2.2",
  "failure_types": {
    "BROKEN_BUILD": {
      "patterns": ["syntax error", "compilation error", "module not found", "import error"],
      "recovery": "rollback"
    },
    "VERIFICATION_FAILED": {
      "patterns": ["verification failed", "test failed", "assertion error"],
      "recovery": "retry"
    },
    "CIRCULAR_FIX": {
      "patterns": [],
      "recovery": "escalate",
      "detection": "attempt_history"
    },
    "CONTEXT_EXHAUSTED": {
      "patterns": ["context limit", "token limit", "too long"],
      "recovery": "compact"
    }
  },
  "max_attempts_per_subtask": 3,
  "escalation_threshold": 3,
  "rollback_safety_commits": 5
}
```

### recovery-manager.js
```javascript
// Key functions:
// - classifyFailure(error, subtaskId) -> FailureType
// - recordAttempt(subtaskId, session, success, approach, error) -> void
// - recordGoodCommit(commitHash, subtaskId) -> void
// - getRecoveryAction(subtaskId, failureType) -> RecoveryAction
// - detectCircularFix(subtaskId, approach) -> boolean
// - rollbackToLastGood(projectDir) -> boolean
```

---

## 6. ğŸ“ Post-Session Processing

### Workflow
```
Session Ends
    â†“
[1] Sync spec to source (worktree mode)
    â†“
[2] Load implementation plan
    â†“
[3] Check subtask status
    â†“
[4] Count new commits
    â†“
[5] If completed:
    â”œâ”€â”€ Record successful attempt
    â”œâ”€â”€ Record good commit
    â”œâ”€â”€ Extract insights (LLM)
    â””â”€â”€ Save to memory
    â†“
[6] If failed:
    â”œâ”€â”€ Record failed attempt
    â”œâ”€â”€ Classify failure
    â”œâ”€â”€ Extract insights anyway
    â””â”€â”€ Determine recovery action
```

---

## ğŸ“‹ Implementation Order

### Phase 1: Core Infrastructure (Day 1)
1. âœ… Create directory structure
2. âœ… thinking-levels.json
3. âœ… agent-configs.json
4. âœ… thinking-manager.js

### Phase 2: Token Optimization (Day 1)
5. âœ… compaction-config.json
6. âœ… context-compactor.js
7. âœ… /compact-context command

### Phase 3: Learning Systems (Day 2)
8. âœ… insight-schema.json
9. âœ… insight-extractor.js
10. âœ… /extract-insights command

### Phase 4: Recovery (Day 2)
11. âœ… recovery-config.json
12. âœ… recovery-manager.js
13. âœ… attempt-history.json template
14. âœ… /recovery-check command

### Phase 5: Integration (Day 3)
15. âœ… Update phase scripts to use thinking levels
16. âœ… Update phase scripts to use compaction
17. âœ… Add post-session processing hook
18. âœ… Update CLAUDE.md to v2.2

---

## ğŸ§ª Testing Plan

### Thinking Levels
```bash
# Test thinking budget lookup
node .claude/thinking/thinking-manager.js --test

# Verify phase defaults
cat .claude/thinking/thinking-levels.json | jq '.phase_defaults'
```

### Context Compaction
```bash
# Test phase output gathering
./scripts/context-compactor.sh --phase P1_DISCOVERY --dry-run

# Test summarization
./scripts/context-compactor.sh --phase P1_DISCOVERY --summarize
```

### Insight Extraction
```bash
# Test extraction (requires recent commits)
./scripts/insight-extractor.sh --session 1 --spec-dir specs/001-feature

# Validate output schema
node .claude/insights/insight-extractor.js --validate
```

### Recovery System
```bash
# Test failure classification
./scripts/recovery-manager.sh --classify "syntax error in file.js"

# Check attempt history
cat .claude/recovery/attempt-history.json | jq '.'

# Test circular fix detection
./scripts/recovery-manager.sh --check-circular subtask-001
```

---

## ğŸ“ˆ Expected Impact

| Metric | Before v2.2 | After v2.2 | Improvement |
|--------|-------------|------------|-------------|
| Token efficiency | Baseline | -30% | Compaction |
| Discovery quality | Good | Excellent | Ultrathink |
| Learning retention | Manual | Automatic | Insights |
| Failure recovery | Manual | Automatic | Recovery |
| Session continuity | Basic | Rich | Post-processing |

---

## ğŸ”— Dependencies

- Node.js 18+ (for JS modules)
- jq (for JSON processing)
- Claude Code CLI
- Git (for commit tracking)

---

*Ready for implementation. Start with Phase 1.*
